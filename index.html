<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ตัวนับเส้นใน PDF</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        touch-action: none;
      }
      #controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        background: #f0f0f0;
        justify-content: center;
      }
      canvas {
        touch-action: none;
        display: block;
        margin: auto;
        border: 1px solid #ccc;
        max-width: 100%;
      }
      button, label {
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <input type="file" id="fileInput" accept="application/pdf" />
      <button onclick="toggleMode()">โหมด: <span id="modeText">ขีดเส้น</span></button>
      <button onclick="undo()">ย้อนกลับ</button>
      <button onclick="savePdf()">บันทึก PDF</button>
      <button onclick="zoomIn()">ซูมเข้า</button>
      <button onclick="zoomOut()">ซูมออก</button>
      <span>จำนวนเส้น: <span id="lineCount">0</span></span>
    </div>
    <canvas id="pdfCanvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      const fileInput = document.getElementById("fileInput");
      const canvas = document.getElementById("pdfCanvas");
      const ctx = canvas.getContext("2d");
      const modeText = document.getElementById("modeText");
      const lineCountText = document.getElementById("lineCount");
      let mode = "draw";
      let lines = JSON.parse(localStorage.getItem("savedLines") || "[]");
      let pdfDoc = null;
      let scale = 1;
      let currentPage = 1;
      let drawing = false;
      let startX, startY;

      let fileData = null;

      const renderPage = async (pageNum) => {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const renderContext = {
          canvasContext: ctx,
          viewport,
        };
        await page.render(renderContext).promise;
        redrawLines();
      };

      const redrawLines = () => {
        for (const line of lines) {
          if (line.page === currentPage) {
            ctx.beginPath();
            ctx.moveTo(line.x1 * scale, line.y1 * scale);
            ctx.lineTo(line.x2 * scale, line.y2 * scale);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = "blue";
            ctx.fillText(line.index, line.x1 * scale + 5, line.y1 * scale - 5);
          }
        }
        lineCountText.textContent = lines.length;
      };

      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        fileData = await file.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument({ data: fileData }).promise;
        currentPage = 1;
        renderPage(currentPage);
      });

      const toggleMode = () => {
        mode = mode === "draw" ? "pan" : "draw";
        modeText.textContent = mode === "draw" ? "ขีดเส้น" : "เลื่อน";
      };

      const undo = () => {
        lines.pop();
        localStorage.setItem("savedLines", JSON.stringify(lines));
        renderPage(currentPage);
      };

      const savePdf = async () => {
        alert("ฟีเจอร์นี้ยังไม่พร้อมใช้งานบนเบราว์เซอร์ ลองแคปหน้าจอแทนหรือใช้เครื่องมือพิเศษในการแปลง PDF");
      };

      canvas.addEventListener("pointerdown", (e) => {
        if (mode !== "draw") return;
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        startX = (e.clientX - rect.left) / scale;
        startY = (e.clientY - rect.top) / scale;
      });

      canvas.addEventListener("pointerup", (e) => {
        if (mode !== "draw" || !drawing) return;
        drawing = false;
        const rect = canvas.getBoundingClientRect();
        const endX = (e.clientX - rect.left) / scale;
        const endY = (e.clientY - rect.top) / scale;
        lines.push({ x1: startX, y1: startY, x2: endX, y2: endY, index: lines.length + 1, page: currentPage });
        localStorage.setItem("savedLines", JSON.stringify(lines));
        renderPage(currentPage);
      });

      const zoomIn = () => {
        scale = Math.min(scale + 0.2, 2.0);
        renderPage(currentPage);
      };

      const zoomOut = () => {
        scale = Math.max(scale - 0.2, 0.5);
        renderPage(currentPage);
      };

      window.onload = () => {
        localStorage.setItem("savedLines", JSON.stringify(lines));
      };
    </script>
  </body>
</html>
