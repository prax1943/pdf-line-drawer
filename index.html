<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ขีดเส้นบน PDF</title>
  <style>
    /* ใส่ style ตามที่ให้ไว้ก่อนหน้า */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f4f4f4;
      overflow: hidden;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #fff;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
    }
    #pdf-container {
      position: relative;
      top: 60px;
      overflow: auto;
      height: calc(100vh - 60px);
      -webkit-overflow-scrolling: touch;
    }
    canvas {
      display: block;
      margin: 0 auto;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <input type="file" id="pdf-upload" accept="application/pdf" />
    <button id="prev-page">⟵ ก่อนหน้า</button>
    <span id="page-info">หน้า 1 / ?</span>
    <button id="next-page">ถัดไป ⟶</button>
    <button id="toggle-mode">โหมด: เลื่อน</button>
    <button id="clear-lines">ล้างเส้น</button>
  </div>

  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
    <canvas id="draw-canvas"></canvas>
  </div>

  <!-- โหลด PDF.js จาก CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <script>
    // ใส่โค้ด JavaScript จาก script.js ที่ให้ไปก่อนหน้านี้ ตรงนี้เลย
    const pdfCanvas = document.getElementById('pdf-canvas');
    const drawCanvas = document.getElementById('draw-canvas');
    const ctx = pdfCanvas.getContext('2d');
    const drawCtx = drawCanvas.getContext('2d');
    const pdfContainer = document.getElementById('pdf-container');

    let pdfDoc = null;
    let currentPage = 1;
    let scale = 2;
    let isDrawing = false;
    let drawingMode = false;
    let lines = {};
    let currentLine = [];

    function saveLines() {
      localStorage.setItem('pdf-lines', JSON.stringify(lines));
    }

    function loadLines() {
      const data = localStorage.getItem('pdf-lines');
      if (data) lines = JSON.parse(data);
    }

    function clearDrawCanvas() {
      drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    }

    function renderLines(pageNum) {
      clearDrawCanvas();
      if (!lines[pageNum]) return;
      drawCtx.strokeStyle = 'red';
      drawCtx.lineWidth = 2;
      drawCtx.beginPath();
      lines[pageNum].forEach(path => {
        drawCtx.moveTo(path[0].x, path[0].y);
        for (let i = 1; i < path.length; i++) {
          drawCtx.lineTo(path[i].x, path[i].y);
        }
      });
      drawCtx.stroke();
    }

    function renderPage(num) {
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale });
        pdfCanvas.width = viewport.width;
        pdfCanvas.height = viewport.height;
        drawCanvas.width = viewport.width;
        drawCanvas.height = viewport.height;

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        page.render(renderContext).promise.then(() => renderLines(num));
      });

      document.getElementById('page-info').textContent = `หน้า ${num} / ${pdfDoc.numPages}`;
    }

    document.getElementById('prev-page').onclick = () => {
      if (currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    };

    document.getElementById('next-page').onclick = () => {
      if (currentPage >= pdfDoc.numPages) return;
      currentPage++;
      renderPage(currentPage);
    };

    document.getElementById('toggle-mode').onclick = () => {
      drawingMode = !drawingMode;
      document.getElementById('toggle-mode').textContent = drawingMode ? 'โหมด: ขีดเส้น' : 'โหมด: เลื่อน';
    };

    document.getElementById('clear-lines').onclick = () => {
      delete lines[currentPage];
      saveLines();
      renderLines(currentPage);
    };

    drawCanvas.addEventListener('pointerdown', e => {
      if (!drawingMode) return;
      isDrawing = true;
      const rect = drawCanvas.getBoundingClientRect();
      currentLine = [{ x: e.clientX - rect.left, y: e.clientY - rect.top }];
    });

    drawCanvas.addEventListener('pointermove', e => {
      if (!isDrawing || !drawingMode) return;
      const rect = drawCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      currentLine.push({ x, y });

      drawCtx.lineWidth = 2;
      drawCtx.strokeStyle = 'red';
      drawCtx.lineCap = 'round';
      drawCtx.beginPath();
      const len = currentLine.length;
      if (len > 1) {
        drawCtx.moveTo(currentLine[len - 2].x, currentLine[len - 2].y);
        drawCtx.lineTo(x, y);
        drawCtx.stroke();
      }
    });

    drawCanvas.addEventListener('pointerup', () => {
      if (!drawingMode) return;
      isDrawing = false;
      if (!lines[currentPage]) lines[currentPage] = [];
      lines[currentPage].push(currentLine);
      saveLines();
    });

    document.getElementById('pdf-upload').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const fileReader = new FileReader();
      fileReader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
          pdfDoc = pdf;
          currentPage = 1;
          loadLines();
          renderPage(currentPage);
        });
      };
      fileReader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
